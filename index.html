<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Teachable Machine Audio + MQTT</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        #label-container div { margin-bottom: 6px; font-size: 18px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
    </style>
</head>
<body>

<h2>Teachable Machine Audio Model</h2>
<button id="start-btn">Start Listening</button>
<div id="label-container"></div>

<!-- Latest TFJS and Speech Commands -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.6.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands/dist/speech-commands.min.js"></script>

<!-- MQTT Client -->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<script>
const client = mqtt.connect("wss://broker.hivemq.com:8884/mqtt");
client.on("connect", () => console.log("MQTT Connected"));

const MODEL_PATH = "my_model/";

async function init() {
    console.log("Button clicked");
    const recognizer = speechCommands.create(
        "BROWSER_FFT",
        undefined,
        MODEL_PATH + "model.json",
        MODEL_PATH + "metadata.json"
    );

    try {
        await recognizer.ensureModelLoaded();
        console.log("Model loaded");
    } catch(e) {
        console.error("Model load failed:", e);
        alert("Failed to load model. Check path.");
        return;
    }

    const labels = recognizer.wordLabels();
    const labelContainer = document.getElementById("label-container");
    labelContainer.innerHTML = "";
    labels.forEach(label => {
        const div = document.createElement("div");
        div.innerHTML = label + ": 0.00";
        labelContainer.appendChild(div);
    });

    try {
        await recognizer.listen(result => {
            result.scores.forEach((score, i) => {
                labelContainer.childNodes[i].innerHTML = labels[i] + ": " + score.toFixed(2);
            });

            const maxIndex = result.scores.indexOf(Math.max(...result.scores));
            if(result.scores[maxIndex] >= 0.75){
                client.publish("tm/audio", labels[maxIndex]);
            }
        }, {
            probabilityThreshold: 0.75,
            includeSpectrogram: true,
            overlapFactor: 0.5
        });
        console.log("Listening started, browser should prompt for mic");
    } catch(err) {
        console.error("Microphone error:", err);
        alert("Microphone access denied or unavailable.");
    }
}

document.getElementById("start-btn").addEventListener("click", init);
</script>
</body>
</html>
